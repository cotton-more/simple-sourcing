# Simple sourcing

> **⚠ Отказ от ответсвенности**  
> Библиотека была написано исключительно в ознакомительных целях. Что бы лучше разобраться как работает Event Sourcing.
> 
> За основу была взята [EventSause for PHP](https://eventsauce.io).

Для работы с библиотекой требуется создать аггрегат, реализующий интерфейс `\CottonMore\SimpleSourcing\AggregateRoot`.

Можно использовать `\CottonMore\SimpleSourcing\AggregateRootBehaviour`, который имеет реализацию всех методов за исключением `AggregateRoot::aggregateRootId()`. В принципе данный метод не используется в библиотеке так что скорее всего он избыточен.

Для того что бы получать и созранять аггреагаты терубется репозиторий. Класс, реализующий интерфейс `\CottonMore\SimpleSourcing\AggregateRootRepository`. Так как библитека писалась поверх уже действующего Laravel-приложения и нужно было натянуть Event Sourcing поверх Eloquent моделей то в качестве параметра для загрузки аггрегата выступает его инстанс, а не AggregateRootId. Последнего, кстати, нет в данной библитеке вовсе для того что бы упростить идею.
Получается что репозиторий получает инстанс модели, выбирает её эвенты из хранилища и применяет их к модели. То есть мутирует переданный инстанс.

Уже есть реализация данного репозитория `\CottonMore\SimpleSourcing\EventSourcedAggregateRootRepository`, которая как раз всё это выполняет.
Ей для работы требуется:

  1. `\CottonMore\SimpleSourcing\MessageRepository`. Данный класс должен получать из хранилища все события указанного аггрегата. А так же сохранять список событий.
  2. Опционально `\CottonMore\SimpleSourcing\MessageDecorator`. Если опущен то будет использован MessageDecoratorChain с пустым списком декораторов. Интерфейс MessageDecorator реализуется классом, который добавляет в событие какие-то дополнительные метаданные.
  3. Опционально `\CottonMore\SimpleSourcing\MessageDispatcher`. Реализует специфичный для приложения механизм регистрации сообщений в системе через консьюмеры.

Работа с аггрегатом выполняется следущим образом

  1. При вызове какого-либо метода происходит формирования объекта события и данный объект записывается в массив, который доступен через метод `AggregateRoot::releaseEvents()`
  2. Аггрегат передаётся в AggregateRootRepository::persist(). Там получаются все записанные события аггрегата, каждое событие оборачивается в инстанс `\CottonMore\SimpleSourcing\Message`. Дополнительно может быть пропущено через MessageDecorator. И после этого сообщения (Message) записываются в хранилище с помощью `MessageRepository::persist()`
  3. Что бы собрать аггрегат нужно создать его инстанс и передать его `\CottonMore\SimpleSourcing\AggregateRootRepository::retrieve()`. Из хранилища загружаются все события, относящиеся к данном аггрегату, и через вызов `\CottonMore\SimpleSourcing\AggregateRoot::reconstituteFromEvents()` последовательно применяются к объекту, мутируюя его. Например, как это сделано `\CottonMore\SimpleSourcing\AggregateRootBehaviour::reconstituteFromEvents()`